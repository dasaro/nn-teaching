<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Routing Example & Demo</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f0f8ff; }
        .demo-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .code-example { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; border-left: 4px solid #007acc; margin: 10px 0; }
        .output { background: #1e1e1e; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .button-group { margin: 10px 0; }
        .demo-btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007acc; color: white; }
        .demo-btn:hover { background: #005a8b; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>üì° Module Routing Demo - Safe Inter-Module Communication</h1>

    <div class="demo-section">
        <h2>üéØ Current Problem (Direct Window Access)</h2>
        <div class="code-example">
// Current problematic pattern:
if (window.i18nUtils && window.i18nUtils.initModuleTranslation) {
    const t = window.i18nUtils.initModuleTranslation('my-module');
}

// Problems:
// ‚ùå Tight coupling - modules know about each other
// ‚ùå Null checking everywhere - defensive programming
// ‚ùå Load order dependencies - modules must load in specific order
// ‚ùå Hard to test - can't easily mock dependencies
        </div>
    </div>

    <div class="demo-section">
        <h2>‚úÖ Solution (Message Bus + Service Registry)</h2>
        <div class="code-example">
// New messaging pattern:
const translationService = messenger.call('i18n', 'initModuleTranslation', 'my-module');
messenger.subscribe('language:changed', (event) => {
    updateUI(event.detail.newLanguage);
});

// Benefits:
// ‚úÖ Loose coupling - modules communicate through messages
// ‚úÖ Safe fallbacks - messenger handles missing services gracefully
// ‚úÖ Load order flexible - services register when ready
// ‚úÖ Easy testing - mock messenger calls
        </div>
    </div>

    <div class="demo-section">
        <h2>üß™ Live Demo</h2>
        <div class="output" id="output"></div>
        
        <div class="button-group">
            <button class="demo-btn" onclick="demoServiceRegistration()">1. Register Services</button>
            <button class="demo-btn" onclick="demoServiceCalls()">2. Call Services</button>
            <button class="demo-btn" onclick="demoEventSystem()">3. Event Broadcasting</button>
            <button class="demo-btn" onclick="demoErrorHandling()">4. Error Handling</button>
            <button class="demo-btn" onclick="showDiagnostics()">5. Diagnostics</button>
            <button class="demo-btn" onclick="clearOutput()">Clear Output</button>
        </div>
    </div>

    <div class="demo-section">
        <h2>üîÑ Migration Strategy</h2>
        <div class="code-example">
// PHASE 1: Add messenger alongside existing code
window.messenger.registerService('i18n', {
    t: (key, replacements) => window.i18n ? window.i18n.t(key, replacements) : key,
    initModuleTranslation: (moduleName) => initModuleTranslation(moduleName)
});

// PHASE 2: Use messenger in new code
const t = messenger.call('i18n', 'initModuleTranslation', 'my-module') || ((key) => key);

// PHASE 3: Gradually migrate existing code
// Replace direct window access with messenger calls over time
        </div>
    </div>

    <!-- Load the new messenger system -->
    <script src="src/module-messenger.js"></script>
    
    <script>
        let outputDiv;
        
        function log(message, type = 'info') {
            if (!outputDiv) outputDiv = document.getElementById('output');
            
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warn' ? 'warning' : 'success';
            
            outputDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function clearOutput() {
            if (outputDiv) outputDiv.innerHTML = '';
        }

        // Demo 1: Service Registration
        function demoServiceRegistration() {
            log('üì° Demo 1: Service Registration', 'info');
            
            // Create mock services
            const mockI18nService = {
                t: (key, replacements = []) => {
                    log(`  üåê Translation called: "${key}" -> "Translated: ${key}"`);
                    return `Translated: ${key}`;
                },
                initModuleTranslation: (moduleName) => {
                    log(`  üîß Module translation initialized for: ${moduleName}`);
                    return (key) => `[${moduleName}] ${key}`;
                }
            };

            const mockUIService = {
                showMessage: (message, type = 'info') => {
                    log(`  üí¨ UI Message (${type}): ${message}`);
                },
                updateStatus: (status) => {
                    log(`  üìä Status updated: ${status}`);
                }
            };

            // Register services
            messenger.registerService('i18n', mockI18nService);
            messenger.registerService('ui', mockUIService, ['showMessage', 'updateStatus']); // Restricted methods
            
            log('‚úÖ Services registered successfully!', 'success');
            log(`üìã Available services: ${messenger.getServices().join(', ')}`, 'info');
        }

        // Demo 2: Service Calls
        function demoServiceCalls() {
            log('üìû Demo 2: Service Calls', 'info');
            
            // Safe service calls
            const translation = messenger.call('i18n', 't', 'app.title');
            log(`üåê Translation result: "${translation}"`, 'success');
            
            const moduleT = messenger.call('i18n', 'initModuleTranslation', 'demo-module');
            if (moduleT) {
                const moduleTranslation = moduleT('button.save');
                log(`üîß Module translation: "${moduleTranslation}"`, 'success');
            }
            
            // Call UI service with restricted methods
            messenger.call('ui', 'showMessage', 'Hello from messenger!', 'success');
            messenger.call('ui', 'updateStatus', 'Demo running...');
            
            // Try calling non-existent service/method (safe failure)
            const result = messenger.call('nonexistent', 'method');
            log(`üö´ Calling non-existent service: ${result}`, 'warning');
        }

        // Demo 3: Event System
        function demoEventSystem() {
            log('üì¢ Demo 3: Event Broadcasting', 'info');
            
            // Subscribe to events
            const unsubscribe1 = messenger.subscribe('demo:test', (event) => {
                log(`  üì® Event received: ${JSON.stringify(event.detail)}`, 'success');
            });
            
            const unsubscribe2 = messenger.subscribe('demo:language-change', (event) => {
                log(`  üåê Language changed to: ${event.detail.language}`, 'success');
            });
            
            // Broadcast events
            setTimeout(() => {
                messenger.broadcast('demo:test', { message: 'Hello Events!', source: 'demo' });
                messenger.broadcast('demo:language-change', { language: 'Italian', code: 'it' });
                
                // Clean up subscriptions after demo
                setTimeout(() => {
                    unsubscribe1();
                    unsubscribe2();
                    log('  üßπ Event subscriptions cleaned up', 'info');
                }, 2000);
            }, 500);
        }

        // Demo 4: Error Handling
        function demoErrorHandling() {
            log('‚ö†Ô∏è Demo 4: Error Handling', 'info');
            
            // Register a service that throws errors
            const buggyService = {
                workingMethod: () => 'This works!',
                crashingMethod: () => {
                    throw new Error('Intentional crash for demo');
                }
            };
            
            messenger.registerService('buggy', buggyService);
            
            // Test error handling
            const goodResult = messenger.call('buggy', 'workingMethod');
            log(`‚úÖ Working method: "${goodResult}"`, 'success');
            
            const badResult = messenger.call('buggy', 'crashingMethod');
            log(`üö® Crashing method result: ${badResult} (gracefully handled)`, 'warning');
            
            // Test missing service/method
            const missing1 = messenger.call('missing-service', 'method');
            const missing2 = messenger.call('buggy', 'missing-method');
            log(`üîç Missing service: ${missing1}, Missing method: ${missing2}`, 'warning');
        }

        // Demo 5: Diagnostics
        function showDiagnostics() {
            log('üìä Demo 5: System Diagnostics', 'info');
            
            const diagnostics = messenger.getDiagnostics();
            
            log(`üîß System Health:`, 'info');
            log(`  ‚Ä¢ Services: ${diagnostics.systemHealth.servicesRegistered}`, 'info');
            log(`  ‚Ä¢ Messages: ${diagnostics.systemHealth.messagesLogged}`, 'info');
            log(`  ‚Ä¢ Uptime: ${Math.round(diagnostics.systemHealth.uptimeMs / 1000)}s`, 'info');
            
            log(`üìã Available Services:`, 'info');
            diagnostics.services.forEach(serviceName => {
                const methods = messenger.getServiceMethods(serviceName);
                log(`  ‚Ä¢ ${serviceName}: ${methods.join(', ')}`, 'info');
            });
            
            const stats = messenger.getStats();
            log(`üìà Message Statistics:`, 'info');
            Object.entries(stats.messagesByType).forEach(([type, count]) => {
                log(`  ‚Ä¢ ${type}: ${count}`, 'info');
            });
        }

        // Initialize demo
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Module Routing Demo Ready!', 'success');
            log('Click the buttons above to see different features in action.', 'info');
            log('', 'info'); // Empty line
        });
    </script>
</body>
</html>