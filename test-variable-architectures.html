<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variable Architecture Test - Neural Network Visualization</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .architecture-tests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-card.active {
            border-color: #4CAF50;
            background: #f0fff0;
        }
        .test-card.error {
            border-color: #f44336;
            background: #fff0f0;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .test-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button.primary {
            background: #4CAF50;
            color: white;
        }
        .test-button.secondary {
            background: #2196F3;
            color: white;
        }
        .test-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        #networkVisualization {
            border: 2px solid #333;
            background: white;
            margin: 20px 0;
        }
        .main-controls {
            text-align: center;
            margin: 20px 0;
        }
        .result-summary {
            margin-top: 30px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧪 Variable Architecture Test Suite</h1>
            <p>Testing neural network visualization with different architectures (0-3 hidden layers)</p>
        </div>

        <div class="architecture-tests">
            <div class="test-card" id="test-no-hidden">
                <h3>📊 No Hidden Layers</h3>
                <p><strong>Architecture:</strong> 4 → [] → 2</p>
                <p>Direct input-to-output connections</p>
                <div class="test-controls">
                    <button class="test-button primary" onclick="testArchitecture([])">Set Architecture</button>
                    <button class="test-button secondary" onclick="runDemo([])">Run Animation</button>
                </div>
                <div class="test-status status-pending" id="status-no-hidden">⏳ Ready to test</div>
            </div>

            <div class="test-card" id="test-one-hidden">
                <h3>🧠 One Hidden Layer</h3>
                <p><strong>Architecture:</strong> 4 → [4] → 2</p>
                <p>Classic 3-layer network</p>
                <div class="test-controls">
                    <button class="test-button primary" onclick="testArchitecture([4])">Set Architecture</button>
                    <button class="test-button secondary" onclick="runDemo([4])">Run Animation</button>
                </div>
                <div class="test-status status-pending" id="status-one-hidden">⏳ Ready to test</div>
            </div>

            <div class="test-card" id="test-two-hidden">
                <h3>🚀 Two Hidden Layers</h3>
                <p><strong>Architecture:</strong> 4 → [6,3] → 2</p>
                <p>Deep network with varying layer sizes</p>
                <div class="test-controls">
                    <button class="test-button primary" onclick="testArchitecture([6, 3])">Set Architecture</button>
                    <button class="test-button secondary" onclick="runDemo([6, 3])">Run Animation</button>
                </div>
                <div class="test-status status-pending" id="status-two-hidden">⏳ Ready to test</div>
            </div>

            <div class="test-card" id="test-three-hidden">
                <h3>⚡ Three Hidden Layers</h3>
                <p><strong>Architecture:</strong> 4 → [8,6,4] → 2</p>
                <p>Maximum depth configuration</p>
                <div class="test-controls">
                    <button class="test-button primary" onclick="testArchitecture([8, 6, 4])">Set Architecture</button>
                    <button class="test-button secondary" onclick="runDemo([8, 6, 4])">Run Animation</button>
                </div>
                <div class="test-status status-pending" id="status-three-hidden">⏳ Ready to test</div>
            </div>

            <div class="test-card" id="test-minimal">
                <h3>💎 Minimal Network</h3>
                <p><strong>Architecture:</strong> 4 → [1] → 2</p>
                <p>Single hidden neuron bottleneck</p>
                <div class="test-controls">
                    <button class="test-button primary" onclick="testArchitecture([1])">Set Architecture</button>
                    <button class="test-button secondary" onclick="runDemo([1])">Run Animation</button>
                </div>
                <div class="test-status status-pending" id="status-minimal">⏳ Ready to test</div>
            </div>

            <div class="test-card" id="test-large">
                <h3>🏗️ Large Network</h3>
                <p><strong>Architecture:</strong> 4 → [8,8] → 2</p>
                <p>Wide hidden layers</p>
                <div class="test-controls">
                    <button class="test-button primary" onclick="testArchitecture([8, 8])">Set Architecture</button>
                    <button class="test-button secondary" onclick="runDemo([8, 8])">Run Animation</button>
                </div>
                <div class="test-status status-pending" id="status-large">⏳ Ready to test</div>
            </div>
        </div>

        <div class="main-controls">
            <button class="test-button primary" onclick="runAllTests()" style="font-size: 16px; padding: 12px 24px;">
                🚀 Run All Architecture Tests
            </button>
            <button class="test-button secondary" onclick="resetAllTests()" style="font-size: 16px; padding: 12px 24px;">
                🔄 Reset All Tests
            </button>
        </div>

        <!-- Network Visualization Area -->
        <div id="networkVisualization">
            <!-- Add canvas elements that image-processor.js expects -->
            <canvas id="inputImage" width="140" height="140" style="display: none;"></canvas>
            <canvas id="pixelCanvas" width="200" height="200" style="display: none;"></canvas>
            
            <svg id="networkSvg" width="800" height="400" viewBox="0 0 800 400"></svg>
        </div>

        <div class="result-summary" id="resultSummary" style="display: none;">
            <h3>📋 Test Results Summary</h3>
            <div id="summaryContent"></div>
        </div>
    </div>

    <!-- Load all required modules in correct order -->
    <script src="locales/en.js"></script>
    <script src="src/utilities.js"></script>
    <script src="src/image-processor.js"></script>
    <script src="src/globals-and-config.js"></script>
    <script src="src/neural-math.js"></script>
    <script src="src/network-api.js"></script>
    <script src="src/module-interfaces.js"></script>
    <script src="src/network-visualizer.js"></script>
    <script src="src/animation-engine.js"></script>
    <script src="src/bootstrap.js"></script>

    <script>
        // Test state
        let testResults = {};
        let currentTest = null;

        // Initialize the application
        window.onload = function() {
            console.log('🧪 Test suite initialized');
            
            // Wait for all modules to load
            setTimeout(() => {
                // Initialize the basic global structures first
                if (typeof initializeNetworkStructure === 'function') {
                    initializeNetworkStructure();
                }
                
                // Set default architecture and initialize
                testArchitecture([4]);
            }, 100);
        };

        function testArchitecture(hiddenLayers) {
            const testName = getTestName(hiddenLayers);
            currentTest = testName;
            
            try {
                console.log(`🧪 Testing architecture: [${hiddenLayers.join(', ')}]`);
                
                // Set the architecture
                NetworkAPI.setArchitecture(hiddenLayers);
                
                // Clear and redraw the network
                clearNetwork();
                drawNetwork();
                
                // Update status
                updateTestStatus(testName, 'success', '✅ Architecture loaded successfully');
                updateTestCard(testName, 'active');
                
                // Store result
                testResults[testName] = {
                    architecture: hiddenLayers,
                    architectureTest: 'success',
                    animationTest: 'pending'
                };
                
                console.log(`✅ Architecture test passed for [${hiddenLayers.join(', ')}]`);
                
            } catch (error) {
                console.error(`❌ Architecture test failed for [${hiddenLayers.join(', ')}]:`, error);
                updateTestStatus(testName, 'error', `❌ Error: ${error.message}`);
                updateTestCard(testName, 'error');
                
                testResults[testName] = {
                    architecture: hiddenLayers,
                    architectureTest: 'error',
                    animationTest: 'not_run',
                    error: error.message
                };
            }
        }

        async function runDemo(hiddenLayers) {
            const testName = getTestName(hiddenLayers);
            
            try {
                console.log(`🎬 Running animation test for [${hiddenLayers.join(', ')}]`);
                updateTestStatus(testName, 'pending', '🎬 Running animation test...');
                
                // Ensure architecture is set
                NetworkAPI.setArchitecture(hiddenLayers);
                clearNetwork();
                drawNetwork();
                
                // Set a test label for backpropagation
                window.trueLabel = 'dog';
                
                // Run the demo
                await startDemo();
                
                updateTestStatus(testName, 'success', '✅ Animation completed successfully');
                
                if (testResults[testName]) {
                    testResults[testName].animationTest = 'success';
                } else {
                    testResults[testName] = {
                        architecture: hiddenLayers,
                        architectureTest: 'not_run',
                        animationTest: 'success'
                    };
                }
                
                console.log(`✅ Animation test passed for [${hiddenLayers.join(', ')}]`);
                
            } catch (error) {
                console.error(`❌ Animation test failed for [${hiddenLayers.join(', ')}]:`, error);
                updateTestStatus(testName, 'error', `❌ Animation error: ${error.message}`);
                updateTestCard(testName, 'error');
                
                if (testResults[testName]) {
                    testResults[testName].animationTest = 'error';
                } else {
                    testResults[testName] = {
                        architecture: hiddenLayers,
                        architectureTest: 'not_run',
                        animationTest: 'error',
                        error: error.message
                    };
                }
            }
        }

        async function runAllTests() {
            console.log('🚀 Running all architecture tests...');
            
            const architectures = [
                [],
                [4],
                [6, 3],
                [8, 6, 4],
                [1],
                [8, 8]
            ];
            
            for (const arch of architectures) {
                console.log(`Testing architecture: [${arch.join(', ')}]`);
                testArchitecture(arch);
                await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause between tests
                
                // Run animation test
                await runDemo(arch);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Pause between animations
            }
            
            // Show summary
            showResultSummary();
        }

        function resetAllTests() {
            testResults = {};
            
            // Reset all test cards
            document.querySelectorAll('.test-card').forEach(card => {
                card.className = 'test-card';
            });
            
            // Reset all status displays
            document.querySelectorAll('[id^="status-"]').forEach(status => {
                status.className = 'test-status status-pending';
                status.textContent = '⏳ Ready to test';
            });
            
            // Hide summary
            document.getElementById('resultSummary').style.display = 'none';
            
            console.log('🔄 All tests reset');
        }

        function getTestName(hiddenLayers) {
            if (hiddenLayers.length === 0) return 'no-hidden';
            if (hiddenLayers.length === 1 && hiddenLayers[0] === 4) return 'one-hidden';
            if (hiddenLayers.length === 2 && hiddenLayers[0] === 6 && hiddenLayers[1] === 3) return 'two-hidden';
            if (hiddenLayers.length === 3 && hiddenLayers[0] === 8) return 'three-hidden';
            if (hiddenLayers.length === 1 && hiddenLayers[0] === 1) return 'minimal';
            if (hiddenLayers.length === 2 && hiddenLayers[0] === 8 && hiddenLayers[1] === 8) return 'large';
            return 'custom';
        }

        function updateTestStatus(testName, status, message) {
            const statusElement = document.getElementById(`status-${testName}`);
            if (statusElement) {
                statusElement.className = `test-status status-${status}`;
                statusElement.textContent = message;
            }
        }

        function updateTestCard(testName, state) {
            const cardElement = document.getElementById(`test-${testName}`);
            if (cardElement) {
                // Clear existing state classes
                cardElement.classList.remove('active', 'error');
                if (state) {
                    cardElement.classList.add(state);
                }
            }
        }

        function clearNetwork() {
            const svg = document.getElementById('networkSvg');
            while (svg.firstChild) {
                svg.removeChild(svg.firstChild);
            }
        }

        function showResultSummary() {
            const summaryDiv = document.getElementById('resultSummary');
            const contentDiv = document.getElementById('summaryContent');
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd;">Architecture</th><th style="padding: 8px; border: 1px solid #ddd;">Visualization</th><th style="padding: 8px; border: 1px solid #ddd;">Animation</th><th style="padding: 8px; border: 1px solid #ddd;">Status</th></tr>';
            
            let totalTests = 0;
            let passedTests = 0;
            
            for (const [testName, result] of Object.entries(testResults)) {
                totalTests++;
                const archStr = result.architecture.length > 0 ? `[${result.architecture.join(', ')}]` : '[]';
                const archStatus = result.architectureTest === 'success' ? '✅' : (result.architectureTest === 'error' ? '❌' : '⏳');
                const animStatus = result.animationTest === 'success' ? '✅' : (result.animationTest === 'error' ? '❌' : '⏳');
                const overallStatus = (result.architectureTest === 'success' && result.animationTest === 'success') ? '✅ PASS' : '❌ FAIL';
                
                if (result.architectureTest === 'success' && result.animationTest === 'success') {
                    passedTests++;
                }
                
                html += `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${archStr}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${archStatus}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${animStatus}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${overallStatus}</td>
                </tr>`;
            }
            
            html += '</table>';
            html += `<p style="margin-top: 15px; font-size: 16px;"><strong>Summary: ${passedTests}/${totalTests} tests passed</strong></p>`;
            
            if (passedTests === totalTests) {
                html += '<p style="color: green; font-weight: bold;">🎉 All tests passed! Variable architecture system is working correctly.</p>';
            } else {
                html += '<p style="color: red; font-weight: bold;">⚠️ Some tests failed. Check console for detailed error messages.</p>';
            }
            
            contentDiv.innerHTML = html;
            summaryDiv.style.display = 'block';
        }

        // Helper function for error handling
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Test suite error:', {msg, url, lineNo, columnNo, error});
            if (currentTest) {
                updateTestStatus(currentTest, 'error', `❌ Unexpected error: ${msg}`);
                updateTestCard(currentTest, 'error');
            }
            return false;
        };
    </script>
</body>
</html>