<!DOCTYPE html>
<html>
<head>
    <title>Multi-Layer Animation Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        button { margin: 5px; padding: 10px; cursor: pointer; }
        #console-output { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Multi-Layer Neural Network Animation Test</h1>
    
    <div class="test-section">
        <h3>Test Controls</h3>
        <button onclick="testSingleLayer()">Test 1 Hidden Layer</button>
        <button onclick="testTwoLayers()">Test 2 Hidden Layers</button>
        <button onclick="testThreeLayers()">Test 3 Hidden Layers</button>
        <button onclick="testPerceptron()">Test Perceptron (0 layers)</button>
        <button onclick="testFullAnimation()">Test Full Animation with Backprop</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div class="test-section">
        <h3>Console Output</h3>
        <div id="console-output"></div>
    </div>
    
    <!-- Include all necessary scripts -->
    <script src="locales/en.js"></script>
    <script src="src/utilities.js"></script>
    <script src="src/neural-math.js"></script>
    <script src="src/globals-and-config.js"></script>
    <script src="src/bootstrap.js"></script>
    <script src="src/network-visualizer.js"></script>
    <script src="src/animation-engine.js"></script>
    <script src="src/ui-controls.js"></script>
    
    <script>
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        
        function logToPage(message, type = 'log') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToPage(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToPage(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToPage(args.join(' '), 'warn');
        };
        
        function clearConsole() {
            document.getElementById('console-output').textContent = '';
        }
        
        function testConfiguration(hiddenLayers, name) {
            console.log(`\\n=== Testing ${name} ===`);
            
            try {
                // Update network configuration (skip drawing)
                const oldDrawNetwork = window.drawNetwork;
                window.drawNetwork = function() { console.log('Skipping drawNetwork in test'); };
                
                const success = updateNetworkToVariableLayers(hiddenLayers);
                console.log(`Network update result: ${success ? 'SUCCESS' : 'FAILED'}`);
                
                // Restore original function
                window.drawNetwork = oldDrawNetwork;
                
                if (success) {
                    console.log(`Network layers: ${networkStructure.layers.map(l => l.name + ':' + l.size).join(' -> ')}`);
                    
                    // Test forward propagation computation
                    const inputValues = [0.5, 0.3, 0.8, 0.2];
                    console.log(`Testing forward propagation with input: [${inputValues.join(', ')}]`);
                    
                    const forwardResult = forwardPropagateCurrentNetwork(inputValues);
                    if (forwardResult && forwardResult.activations) {
                        console.log(`‚úÖ Forward propagation successful`);
                        forwardResult.activations.forEach((layerActivations, index) => {
                            console.log(`  Layer ${index}: [${layerActivations.map(a => a.toFixed(3)).join(', ')}]`);
                        });
                        
                        // Test connection ID generation for animation
                        console.log(`Testing animation connection IDs:`);
                        const layers = forwardResult.layers;
                        for (let layerIndex = 1; layerIndex < layers.length; layerIndex++) {
                            const fromLayer = layers[layerIndex - 1];
                            const toLayer = layers[layerIndex];
                            
                            console.log(`  ${fromLayer.name} -> ${toLayer.name}:`);
                            for (let fromNeuron = 0; fromNeuron < Math.min(2, fromLayer.size); fromNeuron++) {
                                for (let toNeuron = 0; toNeuron < Math.min(2, toLayer.size); toNeuron++) {
                                    const connectionId = generateConnectionId(fromLayer, fromNeuron, toLayer, toNeuron, layerIndex - 1);
                                    console.log(`    Neuron ${fromNeuron} -> ${toNeuron}: ${connectionId}`);
                                }
                            }
                        }
                        
                    } else {
                        console.error(`‚ùå Forward propagation failed`);
                    }
                    
                    // Test backpropagation computation
                    const target = [1, 0];
                    console.log(`Testing backpropagation with target: [${target.join(', ')}]`);
                    
                    const backpropResult = backpropagateCurrentNetwork(target);
                    if (backpropResult) {
                        console.log(`‚úÖ Backpropagation successful`);
                    } else {
                        console.error(`‚ùå Backpropagation failed`);
                    }
                    
                } else {
                    console.error(`‚ùå Failed to update network configuration`);
                }
                
            } catch (error) {
                console.error(`‚ùå Error during test: ${error.message}`);
                console.error(error.stack);
            }
            
            console.log(`=== End ${name} Test ===\\n`);
        }
        
        function testSingleLayer() {
            testConfiguration([4], "Single Hidden Layer (4 neurons)");
        }
        
        function testTwoLayers() {
            testConfiguration([6, 4], "Two Hidden Layers (6, 4 neurons)");
        }
        
        function testThreeLayers() {
            testConfiguration([8, 6, 4], "Three Hidden Layers (8, 6, 4 neurons)");
        }
        
        function testPerceptron() {
            testConfiguration([], "Perceptron (0 hidden layers)");
        }
        
        function testFullAnimation() {
            console.log(`\\n=== Testing Full Animation with Backpropagation ===`);
            
            try {
                // Set up 2 hidden layers
                const hiddenLayers = [6, 4];
                console.log(`Setting up network with ${hiddenLayers.length} hidden layers: [${hiddenLayers.join(', ')}]`);
                
                const success = updateNetworkToVariableLayers(hiddenLayers);
                if (!success) {
                    console.error(`‚ùå Failed to update network configuration`);
                    return;
                }
                
                // Set trueLabel for backpropagation
                console.log(`Setting trueLabel to 'dog' for backpropagation test`);
                if (typeof window.setTrueLabel === 'function') {
                    window.setTrueLabel('dog');
                } else {
                    window.trueLabel = 'dog';
                }
                
                // Set currentImage to dog1 
                if (typeof window.setCurrentImage === 'function') {
                    window.setCurrentImage('dog1');
                } else {
                    window.currentImage = 'dog1';
                }
                
                console.log(`‚úÖ Setup complete. Network configuration:`, networkStructure.layers.map(l => l.name + ':' + l.size).join(' -> '));
                console.log(`‚úÖ True label set to:`, window.trueLabel || 'undefined');
                console.log(`‚úÖ Current image set to:`, window.currentImage || 'undefined');
                
                // Set up test input values 
                const inputValues = [0.5, 0.3, 0.8, 0.2];
                console.log(`Setting up input values: [${inputValues.join(', ')}]`);
                
                // Update activations
                if (typeof window.setActivations === 'function') {
                    window.setActivations({ input: inputValues });
                } else {
                    window.activations = { input: inputValues };
                }
                
                console.log(`üöÄ Starting full animation (forward + backward pass)...`);
                
                // Start the full animation
                if (typeof window.startFullDemo === 'function') {
                    window.startFullDemo();
                } else {
                    console.error(`‚ùå window.startFullDemo function not available`);
                }
                
            } catch (error) {
                console.error(`‚ùå Error during full animation test: ${error.message}`);
                console.error(error.stack);
            }
        }
        
        // Run initial test when page loads
        window.addEventListener('load', function() {
            console.log('Multi-layer animation test loaded');
            testSingleLayer();
        });
    </script>
</body>
</html>